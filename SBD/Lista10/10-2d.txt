SET search_path TO company;

CREATE OR REPLACE FUNCTION fnewworkson () RETURNS TRIGGER AS $$
DECLARE
mycomand TEXT;
mydsummary materializedpsummary1%ROWTYPE;
mynroemp materializedpsummary1.nroemp%TYPE;
mysumhours materializedpsummary1.sumhours%TYPE;
BEGIN
SELECT * FROM materializedpsummary1
INTO mydsummary WHERE pname=NEW.pname;
mynroemp = mydsummary.nroemp + 1;
mysumhours = mydsummary.sumhours + NEW.sumhours;
mycomand := 'UPDATE ' || 'materializeddsummary1 ' || 'SET nroemp = '
 || quote_literal(mynroemp) || ', sumhours = ' || quote_literal(mysumhours)
 || ' ' || 'WHERE pname = ' || quote_literal(NEW.pname);
EXECUTE mycomand;
RETURN NEW;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER tnewworkson BEFORE INSERT ON works_on
FOR EACH ROW EXECUTE PROCEDURE fnewworkson();